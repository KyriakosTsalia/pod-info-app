stages:
  - build
  - package
  - test

variables:
  APP_VERSION: $CI_PIPELINE_IID-$CI_COMMIT_SHORT_SHA

build binary:
  stage: build
  image: golang:1.19-alpine3.17
  script:
    - apk add --no-cache make git build-base gettext
    - mkdir build
    - envsubst < main.html > build/main.html
    - make
  artifacts:
    paths:
      - build

docker build:
  stage: package
  services:
    - docker:23.0.4-dind
  image: docker:23.0.4
  script:
    - apk add curl
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - docker build -t $CI_REGISTRY_IMAGE -t $CI_REGISTRY_IMAGE:$APP_VERSION .
    - docker image ls
    - docker push --all-tags $CI_REGISTRY_IMAGE

integration tests:
  stage: test
  services:
    - name: $CI_REGISTRY_IMAGE:$APP_VERSION
      alias: app
  image: curlimages/curl
  script:
    - curl http://app | grep $APP_VERSION
